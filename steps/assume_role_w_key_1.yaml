template:
  name: assume role w key
  identifier: assume_role_w_key
  versionLabel: "1"
  type: Step
  projectIdentifier: development
  orgIdentifier: default
  tags: {}
  spec:
    timeout: 10m
    type: ShellScript
    spec:
      shell: Bash
      onDelegate: true
      source:
        type: Inline
        spec:
          script: |-
            echo "current role: $(aws sts get-caller-identity | jq -r .Arn)"

            assume="$(aws sts assume-role --role-arn $TARGET_ROLE_ARN --role-session-name '<+stage.name>-<+pipeline.executionId>')"

            export AWS_ACCESS_KEY_ID=$(echo $assume | jq -r .Credentials.AccessKeyId)
            export AWS_SECRET_ACCESS_KEY=$(echo $assume | jq -r .Credentials.SecretAccessKey)
            export AWS_SESSION_TOKEN=$(echo $assume | jq -r .Credentials.SessionToken)

            echo "assumed role: $(aws sts get-caller-identity | jq -r .Arn)"
      environmentVariables:
        - name: AWS_DEFAULT_REGION
          type: String
          value: us-east-1
        - name: AWS_ACCESS_KEY_ID
          type: String
          value: <+input>
        - name: AWS_SECRET_ACCESS_KEY
          type: String
          value: <+input>
        - name: TARGET_ROLE_ARN
          type: String
          value: <+input>
      outputVariables:
        - name: AWS_ACCESS_KEY_ID
          type: Secret
          value: AWS_ACCESS_KEY_ID
        - name: AWS_SECRET_ACCESS_KEY
          type: Secret
          value: AWS_SECRET_ACCESS_KEY
        - name: AWS_SESSION_TOKEN
          type: Secret
          value: AWS_SESSION_TOKEN
